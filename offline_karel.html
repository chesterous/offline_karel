<!DOCTYPE html>
<html>
    <head>
        <title>Offline Karel (one file Karel)</title>
        <style>
            .bone {
                background-repeat: no-repeat;
                background-attachment: fixed;
                background-position: center;
                background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAFiUAABYlAUlSJPAAAAB3SURBVChTY/wPBAxEABSFjIyMUBYEIJsBVwhSdCPAAiwIAxobTiAUQxX+Byr6/6OjAMwGYRAbJAZV8h+uEKYIBtDFmIAMCPCQgDKQAJIYQqGGBsOPCx1gt4IwiA0SgwOwuUAAYv74sQHK+w9mI0n/Jz148AMGBgCKC3d6FXE2lQAAAABJRU5ErkJggg==')
            }
        </style>
    </head>
    <body onload="setup()">
        <script>
            const right = 0
            const down = 1
            const left = 2
            const up = 3
            let ROW = 0
            let COL = 1
            var calls = {
                call_list: [],
                pos: 0
            }
            var ctx
            const box_width = 60
            const box_height = 60
            let cols = 15
            let rows = 6
            var images = {
                empty: new Image(),
                beeper: new Image(),
                karel: new Image(),
                width: 25,
                height: 25
            }
            var state = {
                grid: JSON.parse(JSON.stringify(Array(rows).fill(Array(cols).fill(0)))),
                krow: rows - 1,
                kcol: 0,
                kdir: right
            }
            // code is a character, (e)mpty (b)eeper (k)arel
            function draw(img, col, row, dir = right) {
                if(dir == down) {
                    angle = Math.PI / 2;
                }
                else if(dir == left) {
                    angle = Math.PI;
                }
                else if(dir == up){
                    angle = Math.PI * 3 / 2;
                }
                else {
                    angle = 0;
                }
                if(box_width / images.width > box_height / images.height) {
                    ratio = box_height / images.height
                }
                else {
                    ratio = box_width / images.width
                }
                
                let dx = -img.width * ratio / 2
                let dy = -img.height * ratio / 2

                ctx.save()
                ctx.translate(box_width * (col + .5), box_height * (row + .5))
                ctx.rotate(angle)
                ctx.translate(dx, dy)
                ctx.scale(ratio, ratio)
                ctx.drawImage(img, 0, 0);
                ctx.restore();

                // ctx.canvas.clientWidth
                // let dx = (box_width - img.width * ratio) / 2
                // let dy = (box_height - img.height * ratio) / 2
                // ctx.drawImage(img, box_width * col + dx, box_height * row + dy, img.width * ratio, img.height * ratio)
            }
            function draw_code(code, col, row) {
                if(code == 'e') draw(images.empty, col, row)
                else if(code == 'b') draw(images.beeper, col, row)
                else if(code == 'k') draw(images.karel, col, row)
            }
            function draw_grid() {
                ctx.clearRect(0, 0, box_width * cols, box_height * rows)
                for(let row = 0; row < rows; row++) {
                    for(let col = 0; col < cols; col++) {
                        if(state.grid[row][col] == 0) draw(images.empty, col, row)
                        else draw(images.beeper, col, row)
                    }
                }
            }
            function draw_karel() {
                draw(images.karel, state.kcol, state.krow, state.kdir)
                // ctx.save();
                // ctx.translate(box_width * state.kcol, box_height * state.krow);
                // ctx.rotate(angle);
                // //ctx.translate(-x,-y);
                // ctx.drawImage(images.karel, 0, 0);
                // ctx.restore();
//                draw(images.karel, state.kcol, state.krow)
            }
            // I guess throw out future history if not at the end of the "stack"
            
            function undo_call() {
                if(calls.pos <= 0) {
                    console.log("ERROR - START OF LIST")
                    return
                }
                id = calls.call_list[calls.pos - 1]
                if(id == "move") {
                    if(state.kdir == right) {
                        state.kcol -= 1
                    }
                    else if(state.kdir == down) {
                        state.krow -= 1
                    }
                    else if(state.kdir == left) {
                        state.kcol += 1
                    }
                    else {
                        state.krow += 1
                    }
                }
                else if(id == "turn_left") {
                    state.kdir = (state.kdir + 1) % 4
                }
                else if(id == "put_beeper") {
                    if(state.grid[state.krow][state.kcol] == 0) {
                        console.log("ERROR - NO BEEPERS TO UNDO PUT")
                        return
                    }
                    state.grid[state.krow][state.kcol]--
                }
                else if(id == "pick_beeper") {
                    state.grid[state.krow][state.kcol]++
                }
                calls.pos--
                redraw()
            }
            function do_call() {
                if(calls.pos >= calls.call_list.length) {
                    console.log("ERROR - END OF LIST")
                    return
                }
                id = calls.call_list[calls.pos]
                if(id == "move") {
                    if(state.kdir == right) {
                        if(state.kcol >= cols - 1) {
                            console.log("ERROR - TRYING TO WALK OFF GRID")
                            return
                        }
                        state.kcol += 1
                    }
                    else if(state.kdir == down) {
                        if(state.krow >= rows - 1) {
                            console.log("ERROR - TRYING TO WALK OFF GRID")
                            return
                        }
                        state.krow += 1
                    }
                    else if(state.kdir == left) {
                        if(state.kcol <= 0) {
                            console.log("ERROR - TRYING TO WALK OFF GRID")
                            return
                        }
                        state.kcol -= 1
                    }
                    else {
                        if(state.krow <= 0) {
                            console.log("ERROR - TRYING TO WALK OFF GRID")
                            return
                        }
                        state.krow -= 1
                    }
                }
                else if(id == "turn_left") {
                    state.kdir = (state.kdir + 3) % 4
                }
                else if(id == "put_beeper") {
                    state.grid[state.krow][state.kcol]++
                }
                else if(id == "pick_beeper") {
                    if(state.grid[state.krow][state.kcol] == 0) {
                        console.log("ERROR - NO BEEPERS TO PICK")
                        return
                    }
                    state.grid[state.krow][state.kcol]--
                }
                calls.pos++
                redraw()
            }
            function execute_call(id) {
                // overwrite end of list if you did undo then a new call
                calls.call_list.length = calls.pos
                calls.call_list.push(id)
                do_call()
            }
            function redraw() {
                draw_grid()
                draw_karel()
            }
            function setup() {
                images.empty.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAFiUAABYlAUlSJPAAAAB3SURBVChTY/wPBAxEABSFjIyMUBYEIJsBVwhSdCPAAiwIAxobTiAUQxX+Byr6/6OjAMwGYRAbJAZV8h+uEKYIBtDFmIAMCPCQgDKQAJIYQqGGBsOPCx1gt4IwiA0SgwOwuUAAYv74sQHK+w9mI0n/Jz148AMGBgCKC3d6FXE2lQAAAABJRU5ErkJggg=='
                images.beeper.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABIAAAASCAYAAABWzo5XAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAFiUAABYlAUlSJPAAAAD6SURBVDhPrZSrFsIwDIZb1B4JiUROInk0JBIcEhy8UR30a5aeLOuggu+c0Gv+XDYW35nwBzbTuCDGWK2HphDOJHp53uu6ZTMozcKW3c5iZZ32sm/P7Lxm1IxiOYaQxYpx7/p6TAdCaTYHeSgX0lkOhoOMkFL+ucg8nGQYbjLiB+1mj3IBKyIdFKGaTU67F3+3nVEuA2FsGGT9i6YQ/dHSMNsvoD/aI2UpNDVT8U8HAQ1gmQn5KF7EB0GM8qH+19jQAxppRW1j2dc3HsbtTvy8kM7XnqDPWn0WPaIcInoHsNkgoCIw+4xovWuoiJZj6f4e2SAtl26h74TwAWYqvHtckubbAAAAAElFTkSuQmCC'
                images.karel.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAZCAYAAADE6YVjAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAFiUAABYlAUlSJPAAAAELSURBVEhLzZPREYIwEERTlmVYimVQjqX4aSn8Re7MZjaXOwiojDuzcFySfQlKyifovyApHd/P0EoBAILac6Rd25Og5/VSPU+3xhFsGNIBHlOe5/vbAC31YQh22AAYYmxBmxBZgFCtZccE0R6FfwTRE+C1/Aqid0AMyDODDkHQGwVViDRgqxoKgD1NAEOWXm1wCLKQApKe9gnIGUvdB4q8vgYVEJuDYdby3BBLFUPEOIHnYF1HjSbWjxFzPHvSbjQIyTgAbO6vZdQRmeRNtAC8Eq3L78O1p64rE60ZoC5/z1GQjyYBxAbEfhNcs1YhupB23wR6PapZ4xCC2T4/W4BoE7LXnlYh39IJkJxf7IrWOaXG9JwAAAAASUVORK5CYII='

                ctx = document.getElementById("canv1").getContext("2d");
                
                redraw()
                // draw(images.karel, 0, 2)
                // ctx.drawImage(images.blank, 10, 10);
                // ctx.drawImage(images.beeper, 50, 50);
                // ctx.drawImage(images.karel, 10, 50);
                
            }
            function execute() {
                console.log("execute")
            }
        </script>
        <table style="width:100%">
            <tr>
                <td>
                    <textarea id="ta1" style="width:100%"></textarea>
                    <button onclick="execute()">execute</button>
                </td>
                <td>
                    <canvas id="canv1" width="900" height="360" style="width:100%; border:2px solid #000000;"></canvas>
                    <button onclick="undo_call()">undo</button>
                    <button onclick="do_call()">redo</button>
                    <button onclick='execute_call("move")'>move</button>
                    <button onclick='execute_call("turn_left")'>turn_left</button>
                    <button onclick='execute_call("put_beeper")'>put_beeper</button>
                    <button onclick='execute_call("pick_beeper")'>pick_beeper</button>
                </td>
            </tr>
        </table>
    </body>
</html>