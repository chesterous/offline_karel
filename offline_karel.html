<!DOCTYPE html>
<html>
    <head>
        <title>Offline Karel (one file Karel)</title>
    </head>
    <body onload="setup()">
        <script>
            const constants = {
                // canvas pixels per square
                boxw: 60,
                boxh: 60,
                // base 64 encoded images
                empty_img: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAFiUAABYlAUlSJPAAAAB3SURBVChTY/wPBAxEABSFjIyMUBYEIJsBVwhSdCPAAiwIAxobTiAUQxX+Byr6/6OjAMwGYRAbJAZV8h+uEKYIBtDFmIAMCPCQgDKQAJIYQqGGBsOPCx1gt4IwiA0SgwOwuUAAYv74sQHK+w9mI0n/Jz148AMGBgCKC3d6FXE2lQAAAABJRU5ErkJggg==',
                beeper_img: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABIAAAASCAYAAABWzo5XAAAAxnpUWHRSYXcgcHJvZmlsZSB0eXBlIGV4aWYAAHjabVDbDcMwCPz3FB2Blx08jvOo1A06fiGQKImK5AMO+wyU7ft5l5cboRSpk7beGphJl07DAoWwsSOC7BgJZQ3vfDkLZBSb50i1nQ+Dx1Mg3LCoXoR0ycJ8L3RJfX0I5UfsHXkTawr1FGKKAqbAiLGgdZ2uI8wb3E3jFIe2wD4Ipvozl8m2t1b7h4k2RgZD5hYNsB8pPCwQQ7JLTqHF1bzzx0i2kH97Oqz8AEBfWdj2gKqwAAABhWlDQ1BJQ0MgcHJvZmlsZQAAeJx9kTtIw0Acxr8+pCItDhYRdchQnezgA3EsVSyChdJWaNXB5NIXNGlIUlwcBdeCg4/FqoOLs64OroIg+ABxdnBSdJES/5cUWsR4cNyP7+77uPsO8DarTDH8MUBRTT2diAu5/KoQeIUfgwhhEiMiM7RkZjEL1/F1Dw9f76I8y/3cnyMkFwwGeATiGNN0k3iDeHbT1DjvE4dZWZSJz4kndLog8SPXJYffOJds9vLMsJ5NzxOHiYVSF0tdzMq6QjxDHJEVlfK9OYdlzluclWqdte/JXxgsqCsZrtMcRQJLSCIFARLqqKAKE1FaVVIMpGk/7uIftv0pcknkqoCRYwE1KBBtP/gf/O7WKE5POUnBONDzYlkfY0BgF2g1LOv72LJaJ4DvGbhSO/5aE5j7JL3R0SJHQP82cHHd0aQ94HIHGHrSRF20JR9Nb7EIvJ/RN+WBgVugb83prb2P0wcgS10t3wAHh8B4ibLXXd7d293bv2fa/f0A3R1y0YQLRlIAAA12aVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/Pgo8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA0LjQuMC1FeGl2MiI+CiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPgogIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIKICAgIHhtbG5zOnN0RXZ0PSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VFdmVudCMiCiAgICB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iCiAgICB4bWxuczpHSU1QPSJodHRwOi8vd3d3LmdpbXAub3JnL3htcC8iCiAgICB4bWxuczp0aWZmPSJodHRwOi8vbnMuYWRvYmUuY29tL3RpZmYvMS4wLyIKICAgIHhtbG5zOnhtcD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLyIKICAgeG1wTU06RG9jdW1lbnRJRD0iZ2ltcDpkb2NpZDpnaW1wOjlkM2E5NjQ3LTVmODItNGM1OC05ZTcxLTlhZjczNDNhYTU0MCIKICAgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDpkZDUxN2Q1My1iMjZiLTQ1YmQtYmJmMS0wZGFlZjk5ZWZlYzEiCiAgIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDoxYjYyYzQwYS01ZTc0LTRkODctOTRiMy0zODU3ZjgyNzFiNmEiCiAgIGRjOkZvcm1hdD0iaW1hZ2UvcG5nIgogICBHSU1QOkFQST0iMi4wIgogICBHSU1QOlBsYXRmb3JtPSJXaW5kb3dzIgogICBHSU1QOlRpbWVTdGFtcD0iMTcxMzc5MzkyNjM3NTQyMyIKICAgR0lNUDpWZXJzaW9uPSIyLjEwLjM2IgogICB0aWZmOk9yaWVudGF0aW9uPSIxIgogICB4bXA6Q3JlYXRvclRvb2w9IkdJTVAgMi4xMCIKICAgeG1wOk1ldGFkYXRhRGF0ZT0iMjAyNDowNDoyMlQyMTo1MjowMyswODowMCIKICAgeG1wOk1vZGlmeURhdGU9IjIwMjQ6MDQ6MjJUMjE6NTI6MDMrMDg6MDAiPgogICA8eG1wTU06SGlzdG9yeT4KICAgIDxyZGY6U2VxPgogICAgIDxyZGY6bGkKICAgICAgc3RFdnQ6YWN0aW9uPSJzYXZlZCIKICAgICAgc3RFdnQ6Y2hhbmdlZD0iLyIKICAgICAgc3RFdnQ6aW5zdGFuY2VJRD0ieG1wLmlpZDowYmQ1M2I0Ny1hMmY2LTRkZTgtOTk0ZS00NzE0YzQzMmQyOTYiCiAgICAgIHN0RXZ0OnNvZnR3YXJlQWdlbnQ9IkdpbXAgMi4xMCAoV2luZG93cykiCiAgICAgIHN0RXZ0OndoZW49IjIwMjQtMDQtMjJUMjE6NTI6MDYiLz4KICAgIDwvcmRmOlNlcT4KICAgPC94bXBNTTpIaXN0b3J5PgogIDwvcmRmOkRlc2NyaXB0aW9uPgogPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgIAo8P3hwYWNrZXQgZW5kPSJ3Ij8+NQsvVgAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAAd0SU1FB+gEFg00BuygWF0AAADnSURBVDjLrVSxEYMwEJNyTJLMwCyUzEbJENBBkxZKGIEVlMLGsY3xES664zjzj/5flg38CczEdDEPAPA4I5GEqRt80tSThSyRJGnqBvNTK8Uxn6w4GeWIJ4DWpJD0uw1mlySQBN6Wr/zK0mxCvdjFat8VA46kRs0LkARJaDZd2rWdiCRd65cQ5RapnHoBam80N24GSSKUhNkU125IVvGCj9ZwOfdj+KGi0++cKKp0IFkPrnW2KeLALjrJUNg1UyA6Q9rbze7gUZ+0j+Z+NK5NCIoqcDT9RvzRSFK56vGxwC/Xw91r5TY+4Rh8Eh2MH38AAAAASUVORK5CYII=',
                karel_img: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAZCAYAAADE6YVjAAAAxnpUWHRSYXcgcHJvZmlsZSB0eXBlIGV4aWYAAHjabVDbDcMwCPz3FB2BV4gZx3lU6gYdv9iQKImK5DPcWWeg7N/Pu7x6EEqRaa5qquAhJkbNkwoRbSCCDIzCUsM7X06BnGK/Ocqq+f7g8TSIq3k2XYzqmsJyF0zSvz6M8iPuHZEnWxpZGjGFgGnQYixQq/N1hGWHe9Q4pYOuMAbBdH/WMvv2tsn/YaKdkcGRWaMB7kcKN0/EkfxRp9BzYR28ZSe+kH97OqL8AFY2We82Nzg0AAABhGlDQ1BJQ0MgcHJvZmlsZQAAeJx9kT1Iw0AcxV8/pCItDhYREclQndpFRRxLFYtgobQVWnUwufQLmjQkKS6OgmvBwY/FqoOLs64OroIg+AHi7OCk6CIl/i8ptIjx4Lgf7+497t4B3laNKYY/DiiqqWeSCSFfWBUCr/BjGCFEMS4yQ0tlF3NwHV/38PD1Lsaz3M/9OUJy0WCARyCOM003iTeIZzdNjfM+cZhVRJn4nDiq0wWJH7kuOfzGuWyzl2eG9VxmnjhMLJR7WOphVtEV4hniiKyolO/NOyxz3uKs1Bqsc0/+wmBRXclyneYYklhCCmkIkNBAFTWYiNGqkmIgQ/sJF/+o7U+TSyJXFYwcC6hDgWj7wf/gd7dGaXrKSQomgL4Xy/qYAAK7QLtpWd/HltU+AXzPwJXa9ddbwNwn6c2uFjkCBreBi+uuJu0BlzvAyJMm6qIt+Wh6SyXg/Yy+qQAM3QIDa05vnX2cPgA56mr5Bjg4BCbLlL3u8u7+3t7+PdPp7wfYGXLPnSDscQAADXZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+Cjx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDQuNC4wLUV4aXYyIj4KIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIgogICAgeG1sbnM6c3RFdnQ9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZUV2ZW50IyIKICAgIHhtbG5zOmRjPSJodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLyIKICAgIHhtbG5zOkdJTVA9Imh0dHA6Ly93d3cuZ2ltcC5vcmcveG1wLyIKICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIgogICAgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIgogICB4bXBNTTpEb2N1bWVudElEPSJnaW1wOmRvY2lkOmdpbXA6NzEwNDY2ODQtZDA4ZC00Zjc1LWE2MWItOGYwYmUzNjY4ZjVkIgogICB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOmZhYWY4NDdiLTBiYzMtNGFlMi1iODQ4LTExMzZjZGZlNzU3MyIKICAgeG1wTU06T3JpZ2luYWxEb2N1bWVudElEPSJ4bXAuZGlkOmY2OTI2OGU1LTliNTItNDE0Mi1hYTc4LTljOWE2ZTZhZTFjMyIKICAgZGM6Rm9ybWF0PSJpbWFnZS9wbmciCiAgIEdJTVA6QVBJPSIyLjAiCiAgIEdJTVA6UGxhdGZvcm09IldpbmRvd3MiCiAgIEdJTVA6VGltZVN0YW1wPSIxNzEzNzkzNTcxNTA3NzE4IgogICBHSU1QOlZlcnNpb249IjIuMTAuMzYiCiAgIHRpZmY6T3JpZW50YXRpb249IjEiCiAgIHhtcDpDcmVhdG9yVG9vbD0iR0lNUCAyLjEwIgogICB4bXA6TWV0YWRhdGFEYXRlPSIyMDI0OjA0OjIyVDIxOjQ2OjA5KzA4OjAwIgogICB4bXA6TW9kaWZ5RGF0ZT0iMjAyNDowNDoyMlQyMTo0NjowOSswODowMCI+CiAgIDx4bXBNTTpIaXN0b3J5PgogICAgPHJkZjpTZXE+CiAgICAgPHJkZjpsaQogICAgICBzdEV2dDphY3Rpb249InNhdmVkIgogICAgICBzdEV2dDpjaGFuZ2VkPSIvIgogICAgICBzdEV2dDppbnN0YW5jZUlEPSJ4bXAuaWlkOmI4YjA4NWNiLTY4MjItNGJmNi05ZGVlLWFhZTJiNTA5NTYzZiIKICAgICAgc3RFdnQ6c29mdHdhcmVBZ2VudD0iR2ltcCAyLjEwIChXaW5kb3dzKSIKICAgICAgc3RFdnQ6d2hlbj0iMjAyNC0wNC0yMlQyMTo0NjoxMSIvPgogICAgPC9yZGY6U2VxPgogICA8L3htcE1NOkhpc3Rvcnk+CiAgPC9yZGY6RGVzY3JpcHRpb24+CiA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgCjw/eHBhY2tldCBlbmQ9InciPz65E2CAAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAB3RJTUUH6AQWDS4LIjzeOwAAAVdJREFUSMflVSGWxCAMTfpG5AgrRyIrK1eu5CiVlZXIOQpyjlBZWTlyjhDHihYGKPAYdtUu7/EIgfY3P/kpwH8cpvXBSwNACQyrnSWwTQ5ucx2G4JCmW/K9XTPALAHGz30eg1nDTyIxAAAW5DrL3StE8jKRDN5dE4nhVQGvCoRezhSRTNpNdD1mDazGpuqqBhF6eW3uz33dtiAP1j5W05L4VBUBbFvyjg+EmfrHVF7g/gSabi/avj6icEWyADoPAL0ZCw6pn86fe9BG/QTUT3tUx4wrzLzRRgyr0RxnbvKqDK8q9ge0GA8xZwfArMYzVZaiPWIsgfgRYE7xQaVVCLz01dmW4pd1BIwlnWCKy1zPspGwGgM7l98uigrjpPqXbc9i1iD0Ao9lcUDWTgFhbXOMhUYkA7X7+7h8LzXNMRYakQTn/83e5YSW8DnQhAhr6Gr5ryP82fENnW6vnRrfvVkAAAAASUVORK5CYII=',
                // the dimensions of the images (when rendering, images centered within a box of this size)
                imgw: 25,
                imgh: 25,
                // directions
                right: 0,
                down: 1,
                left: 2,
                up: 3
            }
            var calls = {
                call_list: [],
                pos: 0
            }
            var canv, ctx
            let cols = 15
            let rows = 6
            var images = {
                empty: new Image(),
                beeper: new Image(),
                karel: new Image(),
                width: 25,
                height: 25
            }
            var state = {
                grid: JSON.parse(JSON.stringify(Array(rows).fill(Array(cols).fill(0)))),
                krow: rows - 1,
                kcol: 0,
                kdir: constants.right
            }
            function error(msg) {
                console.log("ERROR - " + msg)
            }
            function draw(img, col, row, dir = constants.right) {
                if(dir == constants.down) {
                    angle = Math.PI / 2;
                }
                else if(dir == constants.left) {
                    angle = Math.PI;
                }
                else if(dir == constants.up){
                    angle = Math.PI * 3 / 2;
                }
                else {
                    angle = 0;
                }
                if(constants.boxw / constants.imgw > constants.boxh / constants.imgh) {
                    ratio = constants.boxh / constants.imgh
                }
                else {
                    ratio = constants.boxw / constants.imgw
                }
                
                let dx = -img.width * ratio / 2
                let dy = -img.height * ratio / 2

                ctx.save()
                ctx.translate(constants.boxw * (col + .5), constants.boxh * (row + .5))
                ctx.rotate(angle)
                ctx.translate(dx, dy)
                ctx.scale(ratio, ratio)
                ctx.drawImage(img, 0, 0);
                ctx.restore();
            }
            function draw_grid() {
                ctx.clearRect(0, 0, constants.boxw * cols, constants.boxh * rows)
                for(let row = 0; row < rows; row++) {
                    for(let col = 0; col < cols; col++) {
                        if(state.grid[row][col] == 0) draw(images.empty, col, row)
                        else draw(images.beeper, col, row)
                    }
                }
            }
            function draw_karel() {
                draw(images.karel, state.kcol, state.krow, state.kdir)
            }
            function try_undo(id) {
                // might add error check later
                if(id == "move") {
                    if(state.kdir == constants.right) {
                        state.kcol -= 1
                    }
                    else if(state.kdir == constants.down) {
                        state.krow -= 1
                    }
                    else if(state.kdir == constants.left) {
                        state.kcol += 1
                    }
                    else {
                        state.krow += 1
                    }
                }
                else if(id == "turn_left") {
                    state.kdir = (state.kdir + 1) % 4
                }
                else if(id == "put_beeper") {
                    if(state.grid[state.krow][state.kcol] == 0) {
                        error("NO BEEPERS TO UNDO PUT")
                        return true
                    }
                    state.grid[state.krow][state.kcol]--
                }
                else if(id == "pick_beeper") {
                    state.grid[state.krow][state.kcol]++
                }
            }
            function try_call(id) {
                if(id == "move") {
                    if(state.kdir == constants.right) {
                        if(state.kcol >= cols - 1) {
                            error("TRYING TO WALK OFF GRID")
                            return true
                        }
                        state.kcol += 1
                    }
                    else if(state.kdir == constants.down) {
                        if(state.krow >= rows - 1) {
                            error("TRYING TO WALK OFF GRID")
                            return true
                        }
                        state.krow += 1
                    }
                    else if(state.kdir == constants.left) {
                        if(state.kcol <= 0) {
                            error("TRYING TO WALK OFF GRID")
                            return true
                        }
                        state.kcol -= 1
                    }
                    else {
                        if(state.krow <= 0) {
                            error("TRYING TO WALK OFF GRID")
                            return true
                        }
                        state.krow -= 1
                    }
                }
                else if(id == "turn_left") {
                    state.kdir = (state.kdir + 3) % 4
                }
                else if(id == "put_beeper") {
                    state.grid[state.krow][state.kcol]++
                }
                else if(id == "pick_beeper") {
                    if(state.grid[state.krow][state.kcol] == 0) {
                        error("NO BEEPERS TO PICK")
                        return true
                    }
                    state.grid[state.krow][state.kcol]--
                }
            }
            function execute_call(id) {
                let err = try_call(id)
                if(!err) {
                    // overwrite end of list if you did undo then a new call
                    calls.call_list.length = calls.pos
                    calls.call_list.push(id)
                    calls.pos++
                    refresh()
                }
            }
            function undo() {
                if(calls.pos <= 0) {
                    error("START OF LIST")
                    return
                }
                id = calls.call_list[calls.pos - 1]
                err = try_undo(id)
                if(!err) {
                    calls.pos--
                    refresh()
                }
            }
            function redo() {
                if(calls.pos >= calls.call_list.length) {
                    error("END OF LIST")
                    return
                }
                id = calls.call_list[calls.pos]
                let err = try_call(id)
                if(!err) {
                    calls.pos++
                    refresh()
                }
            }
            function click_box(col, row) {
                if(state.grid[row][col] > 0) {
                    state.grid[row][col] = 0
                }
                else {
                    state.grid[row][col] = 1
                }
                refresh()
            }
            function type_char(str) {
                if(str == "w") {
                    execute_call("pick_beeper")
                }
                if(str == "s") {
                    execute_call("put_beeper")
                }
                if(str == "d") {
                    execute_call("move")
                }
                if(str == "a") {
                    execute_call("turn_left")
                }
                if(str == "u") {
                    undo()
                }
                if(str == "r") {
                    redo()
                }
            }
            function refresh() {
                let ta = document.getElementById("ta1")
                let tab = document.getElementById("id_title").value
                if(tab == "history") {
                    ta.value = calls.call_list.join("\n")
                }
                else if(tab == "code") {
                    ta.value = "(have not finished supporting coding)"
                }
                draw_grid()
                draw_karel()
            }
            function load_all_images() {
                var counter = 3;
                function waiter() {
                    counter--
                    if(counter == 0) {
                        refresh()
                    }
                }
                images.empty.src = constants.empty_img
                images.beeper.src = constants.beeper_img
                images.karel.src = constants.karel_img
                images.empty.addEventListener('load', waiter)
                images.beeper.addEventListener('load', waiter)
                images.karel.addEventListener('load', waiter)

            }
            function setup() {
                canv = document.getElementById("canv1")
                ctx = canv.getContext("2d");
                
                canv.addEventListener('mousedown', function(e) {
                    const rect = canv.getBoundingClientRect()
                    const col = Math.floor(cols * (e.clientX - rect.left) / rect.width)
                    const row = Math.floor(rows * (e.clientY - rect.top) / rect.height)
                    click_box(col, row)
                })

                onkeypress = function(e) {
                    e = e || window.event
                    var charCode = (typeof e.which == "number") ? e.which : e.keyCode
                    if (charCode > 0) {
                        type_char(String.fromCharCode(charCode))
                    }
                }

                var ta1 = document.getElementById("ta1")
                ta1.onkeypress = function(e) {
                    e.stopPropagation()
                }

                load_all_images()
                
            }
            var cur_tab = 0
            function change_tab(id) {
                // todo
                let tab = document.getElementById("id_title").value
                let ta = document.getElementById("ta1")
                if(tab == "hide") {
                    ta.style.display = "none"
                    document.getElementById("td1").width = 0
                }
                else {
                    ta.style.display = "block"
                }
                refresh()
            }
        </script>
        <table id="tab1" style="width:100%;height:100%">
            <tr>
                <td id="td1" width="16%">
                    <textarea id="ta1" style="width:100%;height:100%"></textarea>
                </td>
                <td>
                    <canvas id="canv1" width="900" height="360" style="width:100%;height:100%;border:2px solid #000000;"></canvas>
                </td>
            </tr>
        </table>
        
        <select name="id_title" id="id_title" onchange="change_tab()">
            <option value="history">history</option>
            <option value="code">code</option>
            <option value="hide">hide</option>
          </select>
          <button onclick="undo()">undo</button>
          <button onclick="redo()">redo</button>
          <button onclick='execute_call("move")'>move</button>
          <button onclick='execute_call("turn_left")'>turn_left</button>
          <button onclick='execute_call("put_beeper")'>put_beeper</button>
          <button onclick='execute_call("pick_beeper")'>pick_beeper</button>
    </body>
</html>